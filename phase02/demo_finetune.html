<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Demo: Fine-Tuning NM Results Management Language Model with a Custom Dataset &mdash; NM Results Management 1.10 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Train" href="train.html" />
    <link rel="prev" title="Demo: Pretraining the NM Results Management Language Model with Custom Corpus" href="demo_pretrain.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> NM Results Management
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Home</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../home.html">NM Results Management AI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#initial-modeling-pre-annotations">Initial Modeling (Pre-Annotations)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#modeling-method-i-regex">Modeling Method I: Regex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#modeling-method-ii-machine-learning">Modeling Method II: Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#modeling-method-iii-deep-learning">Modeling Method III: Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#data-acquisition">Data Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#initial-model-development">Initial Model Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#clinical-workflow-epic-integration">Clinical Workflow &amp; Epic Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#prospective-clinical-evaluation">Prospective Clinical Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#workflow-challenges">Workflow Challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#updating-the-models">Updating the Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#future-plans">Future Plans</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../code.html">Code Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../start.html">Prerequisites</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Phase 01 Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../phase01/phase01.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../phase01/demo.html">Demo: Findings vs No Findings Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../phase01/train.html">Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="../phase01/classify.html">Classify</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Phase 02 Models</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="phase02.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_pretrain.html">Demo: Pretraining the NM Results Management Language Model with Custom Corpus</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Demo: Fine-Tuning NM Results Management Language Model with a Custom Dataset</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Load-the-Data">Load the Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Preprocess-the-Data">Preprocess the Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Tokenize-and-Define-the-Datasets">Tokenize and Define the Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Fine-Tune-the-Model">Fine-Tune the Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Evaluate-the-Results">Evaluate the Results</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="train.html">Train</a></li>
<li class="toctree-l1"><a class="reference internal" href="classify.html">Classify</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Azure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../azure.html">Deployment</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NM Results Management</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Demo: Fine-Tuning NM Results Management Language Model with a Custom Dataset</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/mozzilab/NM_Radiology_AI/blob/main/docs/source/phase02/demo_finetune.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Demo:-Fine-Tuning-NM-Results-Management-Language-Model-with-a-Custom-Dataset">
<h1>Demo: Fine-Tuning NM Results Management Language Model with a Custom Dataset<a class="headerlink" href="#Demo:-Fine-Tuning-NM-Results-Management-Language-Model-with-a-Custom-Dataset" title="Permalink to this headline"></a></h1>
<p>In this notebook, we will be using a sample of 10 radiology reports to show how we can preprocess the data, load the NM Results Management language model checkpoints, and use them for fine-tuning on your in-house data.</p>
<section id="Load-the-Data">
<h2>Load the Data<a class="headerlink" href="#Load-the-Data" title="Permalink to this headline"></a></h2>
<p>First, the data is loaded. In this example, we will train the model to perform a three-class classification problem, determining whether a report contains lung, adrenal, or no findings.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="c1"># Define the path to the data</span>
<span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="s2">&quot;__file__&quot;</span><span class="p">)</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;demo_data.gz&quot;</span><span class="p">))</span>

<span class="c1"># Import data</span>
<span class="n">modeling_df</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">modeling_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_html</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rpt_num</th>
      <th>note</th>
      <th>selected_finding</th>
      <th>selected_proc</th>
      <th>selected_label</th>
      <th>new_note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>PROCEDURE:  CT CHEST WO CONTRAST. HISTORY:  Wheezing TECHNIQUE:  Non-contrast helical thoracic CT was performed. COMPARISON:  There is no prior chest CT for comparison. FINDINGS:   Support Devices:  None. Heart/Pericardium/Great Vessels:        Cardiac size is normal.      There is no calcific coronary artery atherosclerosis.       There is no pericardial effusion.      The aorta is normal in diameter.      The main pulmonary artery is normal in diameter. Pleural Spaces:  Few small pleural calcifications are present in the right pleura for example on 2/62 and 3/76.  The pleural spaces are otherwise clear. Mediastinum/Hila:  There is no mediastinal or hilar lymph node enlargement.  Subcentimeter minimally calcified paratracheal lymph nodes are likely related to prior granulomas infection. Neck Base/Chest Wall/Diaphragm/Upper Abdomen:  There is no supraclavicular or axillary lymph node enlargement.  Limited, non-contrast imaging through the upper abdomen is within normal limits.  Mild degenerative change is present in the spine. Lungs/Central Airways: There is a 15 mm nodular density in the nondependent aspect of the bronchus intermedius on 2/52.  The trachea and central airways are otherwise clear.  There is mild diffuse bronchial wall thickening.  There is a calcified granuloma in the posterior right upper lobe.  The lungs are otherwise clear. CONCLUSIONS:   1.  There is mild diffuse bronchial wall thickening suggesting small airways disease such as asthma or bronchitis in the appropriate clinical setting. 2.  A 3 mm nodular soft tissue attenuation in the nondependent aspect of the right bronchus intermedius is nonspecific, which could be mucus or abnormal soft tissue.  A follow-up CT in 6 months might be considered to evaluate the growth. 3.  Stigmata of old granulomatous disease is present. &amp;#x20; FINAL REPORT Attending Radiologist:</td>
      <td>Lung Findings</td>
      <td>CT Chest</td>
      <td>A 3 mm nodular soft tissue attenuation in the nondependent aspect of the right bronchus intermedius is nonspecific, which could be mucus or abnormal soft tissue.  A follow-up CT in 6 months might be considered to evaluate the growth.</td>
      <td>support devices:  none. heart/pericardium/great vessels:        cardiac size is normal.      there is no calcific coronary artery atherosclerosis.       there is no pericardial effusion.      the aorta is normal in diameter.      the main pulmonary artery is normal in diameter. pleural spaces:  few small pleural calcifications are present in the right pleura for example on 2/62 and 3/76.  the pleural spaces are otherwise clear. mediastinum/hila:  there is no mediastinal or hilar lymph node enlargement.  subcentimeter minimally calcified paratracheal lymph nodes are likely related to prior granulomas infection. neck base/chest wall/diaphragm/upper abdomen:  there is no supraclavicular or axillary lymph node enlargement.  limited, non-contrast imaging through the upper abdomen is within normal limits.  mild degenerative change is present in the spine. lungs/central airways: there is a 15 mm nodular density in the nondependent aspect of the bronchus intermedius on 2/52.  the trachea and central airways are otherwise clear.  there is mild diffuse bronchial wall thickening.  there is a calcified granuloma in the posterior right upper lobe.  the lungs are otherwise clear. conclusions:   1.  there is mild diffuse bronchial wall thickening suggesting small airways disease such as asthma or bronchitis in the appropriate clinical setting. 2.  a 3 mm nodular soft tissue attenuation in the nondependent aspect of the right bronchus intermedius is nonspecific, which could be mucus or abnormal soft tissue.  a follow-up ct in 6 months might be considered to evaluate the growth. 3.  stigmata of old granulomatous disease is present.</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>PROCEDURE:  CT ABDOMEN PELVIS W CONTRAST COMPARISON:  date INDICATIONS:  Lower abdominal/flank pain on the right TECHNIQUE:     After obtaining the patients consent, CT images were created with intravenous iodinated contrast.  FINDINGS:   LIVER:   The liver is normal in size.  No suspicious liver lesion is seen. The portal and hepatic veins are patent. BILIARY:   No biliary duct dilation. The biliary system is otherwise unremarkable. PANCREAS:   No focal pancreatic lesion.  No pancreatic duct dilation. SPLEEN:   No suspicious splenic lesion is seen. The spleen is normal in size. KIDNEYS:   No suspicious renal lesion is seen.  No hydronephrosis. ADRENALS:   No adrenal gland nodule or thickening.  AORTA/VASCULAR:   No aneurysm. RETROPERITONEUM:   No lymphadenopathy. BOWEL/MESENTERY:   The appendix is normal.  No bowel wall thickening or bowel dilation. ABDOMINAL WALL:   No hernia. URINARY BLADDER:   Incomplete bladder distension limits evaluation, but no focal wall thickening or calculus is seen. PELVIC NODES:   No lymphadenopathy.  PELVIC ORGANS:   Status post hysterectomy.  No pelvic mass. BONES:   No acute fracture or suspicious osseous lesion. LUNG BASES:   No pleural effusion or consolidation. OTHER:   Small hiatal hernia. CONCLUSION:   1.  No acute process is detected. 2.  Small hiatal hernia &amp;#x20; FINAL REPORT Attending Radiologist:</td>
      <td>No Findings</td>
      <td>NaN</td>
      <td>No label</td>
      <td>liver:   the liver is normal in size.  no suspicious liver lesion is seen. the portal and hepatic veins are patent. biliary:   no biliary duct dilation. the biliary system is otherwise unremarkable. pancreas:   no focal pancreatic lesion.  no pancreatic duct dilation. spleen:   no suspicious splenic lesion is seen. the spleen is normal in size. kidneys:   no suspicious renal lesion is seen.  no hydronephrosis. adrenals:   no adrenal gland nodule or thickening.  aorta/vascular:   no aneurysm. retroperitoneum:   no lymphadenopathy. bowel/mesentery:   the appendix is normal.  no bowel wall thickening or bowel dilation. abdominal wall:   no hernia. urinary bladder:   incomplete bladder distension limits evaluation, but no focal wall thickening or calculus is seen. pelvic nodes:   no lymphadenopathy.  pelvic organs:   status post hysterectomy.  no pelvic mass. bones:   no acute fracture or suspicious osseous lesion. lung bases:   no pleural effusion or consolidation. other:   small hiatal hernia. conclusion:   1.  no acute process is detected. 2.  small hiatal hernia</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>EXAM:  MRI ABDOMEN W WO CONTRAST CLINICAL INDICATION:  Cirrhosis of liver without ascites, unspecified hepatic cirrhosis type (CMS-HCC) TECHNIQUE: MRI of the abdomen was performed with and without contrast. Multiplanar imaging was performed.  8.5  cc of Gadavist was administered. COMPARISON:  DATE and priors FINDINGS:   On limited views of the lung bases, no acute abnormality is noted. There may be mild distal esophageal wall thickening. On the out of phase series, there is suggestion of some signal gain within the hepatic parenchyma. This is stable. A tiny cystic nonenhancing focus is seen anteriorly in the right hepatic lobe (9/10), unchanged. A subtly micronodular hepatic periphery is noted. There are few subtle hypervascular lesions in the right hepatic lobe, without significant washout. The portal vein is patent. Some splenorenal shunting is redemonstrated, similar to the comparison exam. The spleen measures 12.4 cm in length. No focal splenic lesion is appreciated. There are several small renal lesions again seen, many of which again demonstrate T1 shortening. On the postcontrast subtraction series, no obvious enhancement is noted. The adrenal glands and pancreas are intact. There is mild cholelithiasis, without gallbladder wall thickening or pericholecystic fluid. No free abdominal fluid is visualized. IMPRESSION:   1. Stable cirrhotic appearance of the liver. Few subtly hypervascular hepatic lesions do not demonstrate washout, and probably relate to perfusion variants. No particularly suspicious hepatic mass is seen. 2. Mild splenomegaly to 12.4 cm redemonstrated. Splenorenal shunting is again seen. 3. Scattered simple and complex renal cystic lesions, nonenhancing, stable from March 2040. 4. Incidentally, there is evidence of signal gain in the liver on the out of phase series. This occasionally may represent iron overload.  &amp;#x20; FINAL REPORT Attending Radiologist:</td>
      <td>No Findings</td>
      <td>NaN</td>
      <td>No label</td>
      <td>on limited views of the lung bases, no acute abnormality is noted. there may be mild distal esophageal wall thickening. on the out of phase series, there is suggestion of some signal gain within the hepatic parenchyma. this is stable. a tiny cystic nonenhancing focus is seen anteriorly in the right hepatic lobe (9/10), unchanged. a subtly micronodular hepatic periphery is noted. there are few subtle hypervascular lesions in the right hepatic lobe, without significant washout. the portal vein is patent. some splenorenal shunting is redemonstrated, similar to the comparison exam. the spleen measures 12.4 cm in length. no focal splenic lesion is appreciated. there are several small renal lesions again seen, many of which again demonstrate t1 shortening. on the postcontrast subtraction series, no obvious enhancement is noted. the adrenal glands and pancreas are intact. there is mild cholelithiasis, without gallbladder wall thickening or pericholecystic fluid. no free abdominal fluid is visualized. impression:   1. stable cirrhotic appearance of the liver. few subtly hypervascular hepatic lesions do not demonstrate washout, and probably relate to perfusion variants. no particularly suspicious hepatic mass is seen. 2. mild splenomegaly to 12.4 cm redemonstrated. splenorenal shunting is again seen. 3. scattered simple and complex renal cystic lesions, nonenhancing, stable from march 2040. 4. incidentally, there is evidence of signal gain in the liver on the out of phase series. this occasionally may represent iron overload.</td>
    </tr>
  </tbody>
</table></div>
</div>
</section>
<section id="Preprocess-the-Data">
<h2>Preprocess the Data<a class="headerlink" href="#Preprocess-the-Data" title="Permalink to this headline"></a></h2>
<p>First, the impression (i.e., the findings / conclusions section) of the report is extracted, any doctor signatures are removed, and the report lowercased. This preprocessing section may need to be modified to accommodate your healthcare system’s reports, formatting, etc. The <code class="docutils literal notranslate"><span class="pre">preprocess_note</span></code> function is modified from <code class="docutils literal notranslate"><span class="pre">nmrezman.utils.preprocess_input</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">keyword_split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">return_idx</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract portion of string given a list of possible delimiters (keywords) via partition method</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">keyword</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">keyword</span><span class="p">)[</span><span class="n">return_idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">preprocess_note</span><span class="p">(</span><span class="n">note</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the impression from the note, remove doctor signature, and lowercase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">impression_keywords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;impression:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conclusion(s):&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conclusions:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;conclusion:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;finding:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;findings:&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">signature_keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;&amp;#x20&quot;</span><span class="p">,</span>
        <span class="s2">&quot;final report attending radiologist:&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">impressions</span> <span class="o">=</span> <span class="n">keyword_split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">note</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">impression_keywords</span><span class="p">)</span>
    <span class="n">impressions</span> <span class="o">=</span> <span class="n">keyword_split</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="n">signature_keywords</span><span class="p">,</span> <span class="n">return_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">impressions</span>

<span class="c1"># Preprocess the note</span>
<span class="n">modeling_df</span><span class="p">[</span><span class="s2">&quot;impression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modeling_df</span><span class="p">[</span><span class="s2">&quot;note&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">preprocess_note</span><span class="p">)</span>
<span class="n">modeling_df</span> <span class="o">=</span> <span class="n">modeling_df</span><span class="p">[</span><span class="n">modeling_df</span><span class="p">[</span><span class="s2">&quot;impression&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
<span class="n">modeling_df</span><span class="p">[</span><span class="s2">&quot;impression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modeling_df</span><span class="p">[</span><span class="s2">&quot;impression&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Here we encode the findings label into integer labels for the model to interpret.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">preprocessing</span>

<span class="c1"># Encode the Lung, Adrenal, and No Finding into integer labels</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">LabelEncoder</span><span class="p">()</span>
<span class="n">le</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">modeling_df</span><span class="p">[</span><span class="s2">&quot;selected_finding&quot;</span><span class="p">])</span>
<span class="n">modeling_df</span><span class="p">[</span><span class="s2">&quot;int_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">modeling_df</span><span class="p">[</span><span class="s2">&quot;selected_finding&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>The data is split into train and test sets (as lists so that it is formatted for the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Split the data into train and test</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">modeling_df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">modeling_df</span><span class="p">[</span><span class="s2">&quot;selected_finding&quot;</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">37</span><span class="p">)</span>
<span class="n">train_note</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;impression&quot;</span><span class="p">])</span>
<span class="n">train_label</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;int_labels&quot;</span><span class="p">])</span>
<span class="n">test_note</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;impression&quot;</span><span class="p">])</span>
<span class="n">test_label</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;int_labels&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</section>
<section id="Tokenize-and-Define-the-Datasets">
<h2>Tokenize and Define the Datasets<a class="headerlink" href="#Tokenize-and-Define-the-Datasets" title="Permalink to this headline"></a></h2>
<p>First, we define a tokenizer to mask words or word fragments to tokens. Here, we are using <a class="reference external" href="https://huggingface.co/roberta-base">🤗’s pretrained RoBERTa base model’s</a> checkpoint. Padding is done on the left side since NM radiology reports generally have the findings at the end of the report. Note that you can change out the tokenizer and model to start from a different RoBERTa checkpoint (e.g., <code class="docutils literal notranslate"><span class="pre">roberta-large</span></code>).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span>

<span class="c1"># Define the tokenizer (from a pre-trained checkpoint) and tokenize the notes</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;roberta-base&quot;</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="n">train_encodings</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">train_note</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">val_encodings</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">test_note</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Next, we define a custom Pytorch <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> class. This will return the tokenized report text and integer label for a given index. 🤗 can easily use custom Pytorch <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>s for training data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>

<span class="k">class</span> <span class="nc">Reports_Dataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encodings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encodings</span> <span class="o">=</span> <span class="n">encodings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encodings</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">item</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>

<span class="c1"># Define the trainign dataset with tokenized notes and labels</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">Reports_Dataset</span><span class="p">(</span><span class="n">train_encodings</span><span class="p">,</span> <span class="n">train_label</span><span class="p">)</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">Reports_Dataset</span><span class="p">(</span><span class="n">val_encodings</span><span class="p">,</span> <span class="n">test_label</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Fine-Tune-the-Model">
<h2>Fine-Tune the Model<a class="headerlink" href="#Fine-Tune-the-Model" title="Permalink to this headline"></a></h2>
<p>First, we load the pretrained model (similar to the one that was pretrained via the notebook <code class="docutils literal notranslate"><span class="pre">Demo:</span> <span class="pre">Phase</span> <span class="pre">02</span> <span class="pre">Pretraining</span> <span class="pre">the</span> <span class="pre">NM</span> <span class="pre">Results</span> <span class="pre">Management</span> <span class="pre">Language</span> <span class="pre">Model</span> <span class="pre">with</span> <span class="pre">Custom</span> <span class="pre">Corpus</span></code> only trained on thousands of reports). This model will be fine-tuned to a specific task, which, in this case, is a multi-class classification problem that determines if a report has Lung Findings, Adrenal Findings, or No Findings.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span>

<span class="c1"># TODO: point to the pretrained model trained as part of the pretraining process</span>
<span class="c1"># Here, we are using a pretrained checkpoint trained on thousands of reports (vs the pretrained model wieghts generated via the notebook ``demo_pretrain``)</span>
<span class="c1"># To use the only directly trained by the notebook, use &quot;/path/to/results/phase02/demo/checkpoint-4&quot;</span>
<span class="n">model_pretrained_path</span> <span class="o">=</span> <span class="s2">&quot;/path/to/results/phase02/demo/checkpoint-14500&quot;</span>

<span class="c1"># Fine-tune the model from the pre-trained checkpoint</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_pretrained_path</span><span class="p">,</span> <span class="n">num_labels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Some weights of the model checkpoint at /path/to/results/phase02/demo/checkpoint-14500 were not used when initializing RobertaForSequenceClassification: [&#39;lm_head.layer_norm.bias&#39;, &#39;lm_head.layer_norm.weight&#39;, &#39;lm_head.dense.bias&#39;, &#39;lm_head.bias&#39;, &#39;lm_head.dense.weight&#39;]
- This IS expected if you are initializing RobertaForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing RobertaForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).
Some weights of RobertaForSequenceClassification were not initialized from the model checkpoint at /path/to/results/phase02/demo/checkpoint-14500 and are newly initialized: [&#39;classifier.dense.bias&#39;, &#39;classifier.out_proj.bias&#39;, &#39;classifier.dense.weight&#39;, &#39;classifier.out_proj.weight&#39;]
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
</pre></div></div>
</div>
<p>Here we begin training using the 🤗 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>, which will train according to the parameters specified in the 🤗 <code class="docutils literal notranslate"><span class="pre">TrainingArguments</span></code>. 🤗 will take care of all the training for us! When done, the last checkpoint will be used as for classifying reports for Lung, Adrenal, or No Findings.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">Trainer</span><span class="p">,</span> <span class="n">TrainingArguments</span>

<span class="c1"># Define the training parameters and 🤗 Trainer</span>
<span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
                    <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;/path/to/results/phase02/demo/findings&quot;</span><span class="p">,</span>    <span class="c1"># output directory</span>
                    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>                                    <span class="c1"># total number of training epochs</span>
                    <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>                         <span class="c1"># batch size per device during training</span>
                    <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>                           <span class="c1"># batch size per device during evaluation</span>
                    <span class="n">warmup_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>                                       <span class="c1"># number of warmup steps for learning rate scheduler</span>
                    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span>                                     <span class="c1"># strength of weight decay</span>
                    <span class="n">fp16</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>                                              <span class="c1"># mixed precision training</span>
                    <span class="n">do_predict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>                                        <span class="c1"># run predictions on test set</span>
                    <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>                            <span class="c1"># load best model at end so we can run confusion matrix</span>
                    <span class="n">logging_steps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>                                        <span class="c1"># remaining args are related to logging</span>
                    <span class="n">save_total_limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">evaluation_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                    <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                    <span class="n">report_to</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>                                            <span class="c1"># the instantiated 🤗 Transformers model to be trained</span>
                    <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>                                     <span class="c1"># training arguments, defined above</span>
                    <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>                            <span class="c1"># training dataset</span>
                    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">val_dataset</span><span class="p">,</span>                               <span class="c1"># test (evaluation) dataset: save and eval strategy to match</span>
<span class="p">)</span>

<span class="c1"># Train!</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Using amp half precision backend
/usr/local/lib/python3.8/dist-packages/transformers/optimization.py:306: FutureWarning: This implementation of AdamW is deprecated and will be removed in a future version. Use thePyTorch implementation torch.optim.AdamW instead, or set `no_deprecation_warning=True` to disable this warning
  warnings.warn(
***** Running training *****
  Num examples = 7
  Num Epochs = 40
  Instantaneous batch size per device = 16
  Total train batch size (w. parallel, distributed &amp; accumulation) = 16
  Gradient Accumulation steps = 1
  Total optimization steps = 40
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
    <div>

      <progress value='40' max='40' style='width:300px; height:20px; vertical-align: middle;'></progress>
      [40/40 01:15, Epoch 40/40]
    </div>
    <table border="1" class="dataframe">
  <thead>
 <tr style="text-align: left;">
      <th>Epoch</th>
      <th>Training Loss</th>
      <th>Validation Loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>No log</td>
      <td>1.090820</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1.093700</td>
      <td>1.090332</td>
    </tr>
    <tr>
      <td>3</td>
      <td>1.093700</td>
      <td>1.089355</td>
    </tr>
    <tr>
      <td>4</td>
      <td>1.086800</td>
      <td>1.088135</td>
    </tr>
    <tr>
      <td>5</td>
      <td>1.086800</td>
      <td>1.086182</td>
    </tr>
    <tr>
      <td>6</td>
      <td>1.101900</td>
      <td>1.083984</td>
    </tr>
    <tr>
      <td>7</td>
      <td>1.101900</td>
      <td>1.081299</td>
    </tr>
    <tr>
      <td>8</td>
      <td>1.077500</td>
      <td>1.078125</td>
    </tr>
    <tr>
      <td>9</td>
      <td>1.077500</td>
      <td>1.074707</td>
    </tr>
    <tr>
      <td>10</td>
      <td>1.096700</td>
      <td>1.071045</td>
    </tr>
    <tr>
      <td>11</td>
      <td>1.096700</td>
      <td>1.066895</td>
    </tr>
    <tr>
      <td>12</td>
      <td>1.069300</td>
      <td>1.063110</td>
    </tr>
    <tr>
      <td>13</td>
      <td>1.069300</td>
      <td>1.058838</td>
    </tr>
    <tr>
      <td>14</td>
      <td>1.042600</td>
      <td>1.054077</td>
    </tr>
    <tr>
      <td>15</td>
      <td>1.042600</td>
      <td>1.049561</td>
    </tr>
    <tr>
      <td>16</td>
      <td>1.043200</td>
      <td>1.044678</td>
    </tr>
    <tr>
      <td>17</td>
      <td>1.043200</td>
      <td>1.039795</td>
    </tr>
    <tr>
      <td>18</td>
      <td>0.978700</td>
      <td>1.034790</td>
    </tr>
    <tr>
      <td>19</td>
      <td>0.978700</td>
      <td>1.030029</td>
    </tr>
    <tr>
      <td>20</td>
      <td>0.941100</td>
      <td>1.025269</td>
    </tr>
    <tr>
      <td>21</td>
      <td>0.941100</td>
      <td>1.020630</td>
    </tr>
    <tr>
      <td>22</td>
      <td>0.910500</td>
      <td>1.016968</td>
    </tr>
    <tr>
      <td>23</td>
      <td>0.910500</td>
      <td>1.013428</td>
    </tr>
    <tr>
      <td>24</td>
      <td>0.869600</td>
      <td>1.010620</td>
    </tr>
    <tr>
      <td>25</td>
      <td>0.869600</td>
      <td>1.007324</td>
    </tr>
    <tr>
      <td>26</td>
      <td>0.771500</td>
      <td>1.003967</td>
    </tr>
    <tr>
      <td>27</td>
      <td>0.771500</td>
      <td>0.999207</td>
    </tr>
    <tr>
      <td>28</td>
      <td>0.772400</td>
      <td>0.993286</td>
    </tr>
    <tr>
      <td>29</td>
      <td>0.772400</td>
      <td>0.985840</td>
    </tr>
    <tr>
      <td>30</td>
      <td>0.708900</td>
      <td>0.975403</td>
    </tr>
    <tr>
      <td>31</td>
      <td>0.708900</td>
      <td>0.966370</td>
    </tr>
    <tr>
      <td>32</td>
      <td>0.651300</td>
      <td>0.960327</td>
    </tr>
    <tr>
      <td>33</td>
      <td>0.651300</td>
      <td>0.958374</td>
    </tr>
    <tr>
      <td>34</td>
      <td>0.524000</td>
      <td>0.957214</td>
    </tr>
    <tr>
      <td>35</td>
      <td>0.524000</td>
      <td>0.954956</td>
    </tr>
    <tr>
      <td>36</td>
      <td>0.412900</td>
      <td>0.951202</td>
    </tr>
    <tr>
      <td>37</td>
      <td>0.412900</td>
      <td>0.948364</td>
    </tr>
    <tr>
      <td>38</td>
      <td>0.346000</td>
      <td>0.949860</td>
    </tr>
    <tr>
      <td>39</td>
      <td>0.346000</td>
      <td>0.955627</td>
    </tr>
    <tr>
      <td>40</td>
      <td>0.311500</td>
      <td>0.955841</td>
    </tr>
  </tbody>
</table><p></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-1
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-1/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-1/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-14] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-2
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-2/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-2/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-15] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-3
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-3/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-3/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-1] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-4
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-4/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-4/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-2] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-5
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-5/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-5/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-3] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-6
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-6/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-6/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-4] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-7
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-7/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-7/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-5] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-8
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-8/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-8/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-6] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-9
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-9/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-9/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-7] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-10
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-10/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-10/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-8] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-11
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-11/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-11/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-9] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-12
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-12/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-12/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-10] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-13
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-13/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-13/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-11] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-14
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-14/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-14/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-12] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-15
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-15/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-15/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-13] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-16
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-16/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-16/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-14] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-17
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-17/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-17/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-15] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-18
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-18/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-18/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-16] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-19
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-19/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-19/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-17] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-20
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-20/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-20/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-18] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-21
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-21/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-21/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-19] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-22
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-22/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-22/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-20] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-23
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-23/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-23/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-21] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-24
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-24/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-24/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-22] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-25
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-25/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-25/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-23] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-26
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-26/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-26/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-24] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-27
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-27/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-27/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-25] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-28
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-28/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-28/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-26] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-29
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-29/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-29/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-27] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-30
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-30/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-30/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-28] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-31
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-31/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-31/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-29] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-32
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-32/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-32/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-30] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-33
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-33/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-33/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-31] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-34
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-34/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-34/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-32] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-35
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-35/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-35/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-33] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-36
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-36/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-36/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-34] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-37
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-37/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-37/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-35] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-38
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-38/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-38/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-36] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-39
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-39/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-39/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-38] due to args.save_total_limit
***** Running Evaluation *****
  Num examples = 4
  Batch size = 8
Saving model checkpoint to /path/to/results/phase02/demo/findings/checkpoint-40
Configuration saved in /path/to/results/phase02/demo/findings/checkpoint-40/config.json
Model weights saved in /path/to/results/phase02/demo/findings/checkpoint-40/pytorch_model.bin
Deleting older checkpoint [/path/to/results/phase02/demo/findings/checkpoint-39] due to args.save_total_limit


Training completed. Do not forget to share your model on huggingface.co/models =)


Loading best model from /path/to/results/phase02/demo/findings/checkpoint-37 (score: 0.9483642578125).
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TrainOutput(global_step=40, training_loss=0.8405103325843811, metrics={&#39;train_runtime&#39;: 75.1838, &#39;train_samples_per_second&#39;: 3.724, &#39;train_steps_per_second&#39;: 0.532, &#39;total_flos&#39;: 37091533086720.0, &#39;train_loss&#39;: 0.8405103325843811, &#39;epoch&#39;: 40.0})
</pre></div></div>
</div>
</section>
<section id="Evaluate-the-Results">
<h2>Evaluate the Results<a class="headerlink" href="#Evaluate-the-Results" title="Permalink to this headline"></a></h2>
<p>Using <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>’s <code class="docutils literal notranslate"><span class="pre">classification_report</span></code> and <code class="docutils literal notranslate"><span class="pre">confusion_matrix</span></code>, we can evaluate how well the model performs on the test dataset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span>

<span class="c1"># Perform confusion matrix and print the results</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred</span><span class="o">.</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">test_label</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">test_label</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
***** Running Prediction *****
  Num examples = 4
  Batch size = 8
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>

  <progress value='1' max='1' style='width:300px; height:20px; vertical-align: middle;'></progress>
  [1/1 : < :]
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
              precision    recall  f1-score   support

           0       1.00      1.00      1.00         1
           1       0.50      1.00      0.67         1
           2       1.00      0.50      0.67         2

    accuracy                           0.75         4
   macro avg       0.83      0.83      0.78         4
weighted avg       0.88      0.75      0.75         4

[[1 0 0]
 [0 1 0]
 [0 1 1]]
</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="demo_pretrain.html" class="btn btn-neutral float-left" title="Demo: Pretraining the NM Results Management Language Model with Custom Corpus" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="train.html" class="btn btn-neutral float-right" title="Train" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NM HIT.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>